#!/bin/bash
# ============================================
# SSH setup and Ansible managed node preparation
# Works on Ubuntu-based systems
# ============================================

# 1. Update system
sudo apt update && sudo apt upgrade -y

# -------------------------------------------------
# 2. Check if SSH SERVER (openssh-server) is installed
# -------------------------------------------------
dpkg -l | grep openssh-server || echo "⚠️  SSH server not installed."

# Install SSH server if missing
sudo apt install openssh-server -y

# Enable and start the SSH service
sudo systemctl enable ssh
sudo systemctl start ssh

# Verify service status (should be active)
sudo systemctl is-active ssh

# -------------------------------------------------
# 3. Check if port 22 is listening (SSH port)
# -------------------------------------------------
sudo ss -tuln | grep :22 || echo "⚠️  Port 22 not listening. Check firewall or SSH service."

# -------------------------------------------------
# 4. Check SSH client (for outgoing SSH commands)
# -------------------------------------------------
ssh -V || echo "⚠️  SSH client not installed."
sudo apt install openssh-client -y

# -------------------------------------------------
# 5. (Optional) Install Python SSH module (Paramiko)
# -------------------------------------------------
pip3 list | grep paramiko || echo "⚠️  Paramiko not installed."
pip3 install paramiko
python3 -c "import paramiko; print('✅ Paramiko available')"

# -------------------------------------------------
# 6. Create Ansible user for managed node
# -------------------------------------------------
# You can change 'ansible' to any username you prefer
sudo adduser --disabled-password --gecos "" ansible
sudo usermod -aG sudo ansible

# -------------------------------------------------
# 7. Allow SSH key-based authentication
# -------------------------------------------------
# Create .ssh directory for the Ansible user
sudo mkdir -p /home/ansible/.ssh
sudo chmod 700 /home/ansible/.ssh
sudo chown ansible:ansible /home/ansible/.ssh

echo "✅ SSH directory prepared for 'ansible' user."
echo "Copy your public key from the control node using:"
echo "ssh-copy-id ansible@<managed-node-IP>"

# -------------------------------------------------
# 8. Final summary
# -------------------------------------------------
echo ""
echo "============================================"
echo "✅ SSH and Ansible managed node setup complete!"
echo "- SSH server installed and running"
echo "- Port 22 listening"
echo "- SSH client and Paramiko available"
echo "- User 'ansible' created with sudo privileges"
echo "- Ready for Ansible control node connection"
echo "============================================"


**********************************************************************

To run:

chmod +x setup_ansible_managed_node.sh
./setup_ansible_managed_node.sh


Once this finishes, you’ll just need to:

From your control node, run:

ssh-copy-id ansible@<managed-node-IP>

Then test the connection from Ansible:

ansible all -i "<managed-node-IP>," -u ansible -m ping



